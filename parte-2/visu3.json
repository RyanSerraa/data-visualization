{
  "title": "Tempo médio de atraso para os 10 aeroportos com maior taxa de atraso",
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "url": "dump.json"
  },
  "transform": [
    {
      "filter": "datum.SituacaoVoo == 'Realizado'"
    },
    {
      "calculate": "datetime(datum['PartidaReal']) - datetime(datum['PartidaPrevista'])",
      "as": "delay"
    },
    {
      "calculate": "datum.delay > 5 * 60 * 1000 ? 1 : 0",
      "as": "isDelayed"
    },
    {
      "calculate": "datum.delay > 5 * 60 * 1000 ? datum.delay/60000 : 0",
      "as": "meanDelay"
    },
    {
      "aggregate": [
        { "op": "sum", "field": "isDelayed", "as": "delayedCount" },
        { "op": "count", "as": "totalCount" },
        { "op": "mean", "field": "meanDelay", "as": "meanDelay" }
      ],
      "groupby": ["AeroportoOrigem"]
    },
    {
      "calculate": "datum.totalCount > 0 ? (datum.delayedCount / datum.totalCount) * 100 : 0",
      "as": "delayRate"
    },
    { "sort": [{ "field": "delayRate", "order": "descending" }] },
    { "window": [{ "op": "rank", "as": "rank" }] },
    { "filter": "datum.rank <= 10" }
  ],
  "mark": "bar",
  "encoding": {
    "x": {
      "field": "AeroportoOrigem",
      "type": "nominal",
      "axis": { "labelAngle": -45 },
      "title": "Aeroporto",
      "sort": { "field": "delayRate", "order": "descending" }
    },
    "y": {
      "field": "meanDelay",
      "type": "quantitative",
      "title": "Atraso médio (min)"
    },
    "color": { "field": "AeroportoOrigem", "type": "nominal", "legend": null },
    "tooltip": [
      { "field": "AeroportoOrigem", "type": "nominal", "title": "Aeroporto" },
      {
        "field": "delayRate",
        "type": "quantitative",
        "title": "Taxa de Atraso (%)",
        "format": ".2f"
      },
      {
        "field": "delayedCount",
        "type": "quantitative",
        "title": "Total de Voos Atrasados"
      },
      {
        "field": "totalCount",
        "type": "quantitative",
        "title": "Total de Voos"
      },
      {
        "field": "meanDelay",
        "type": "quantitative",
        "title": "Tempo médio de atraso (min)",
        "format": ".0f"
      }
    ]
  },
  "width": 500,
  "height": 300
}
